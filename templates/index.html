<!DOCTYPE html>
<html>

<head>
    <title>House Listings</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            font-size: 14px;
        }

        header {
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #006AFF;
            color: white;
            padding: 0.5em 2em;
        }

        .header-bottom {
            display: flex;
            align-items: center;
            padding: 0.5em 2em;
            background-color: #fff;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
            justify-content: flex-start;
            /* Ensure content starts from the left */
        }

        .header-top .logo {
            font-size: 24px;
            color: white;
            text-decoration: none;
            font-weight: 700;
        }

        .header-nav,
        .saved-searches {
            display: flex;
        }

        .deals-dropdown {
            position: relative;
            display: inline-block;
        }

        .deal-button {
            padding: 0.5em 1em;
            background-color: #fff;
            /* White background */
            color: #333;
            border: 1px solid #ddd;
            border-radius: 20px;
            /* Rounded edges */
            cursor: pointer;
            margin-right: 8px;
            /* Add some margin to the right */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* Optional: Add subtle shadow */
            transition: all 0.3s ease;
            /* Smooth transition for color changes */
        }


        /* Style for the dropdown content container */
        .deals-dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            /* White background */
            min-width: 250px;
            /* Adjust to match the design */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* Shadow for the dropdown */
            z-index: 1;
            border-radius: 8px;
            /* Match the border radius */
            padding: 12px;
            border: 1px solid #ddd;
            /* Add a border */
            top: 100%;
            /* Align it right below the dropdown button */
            left: 0;
            /* Align to the left edge of the .deals-dropdown */
            margin-top: 4px;
            /* Add a little space between button and dropdown */
        }

        /* Hover state for the dropdown button */
        .deal-button:hover {
            background-color: #e0e0e0;
            /* Lighter shade on hover */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            /* Optional: Slightly deeper shadow on hover */
        }

        /* Style for dropdown labels and inputs */
        .deals-dropdown-content label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            /* Set the text color */
        }

        .deals-dropdown-content input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            /* Rounded corners for input fields */
            box-sizing: border-box;
            /* Include padding and border in the element's total width and height */
        }

        /* Button container styles */
        .dropdown-buttons {
            display: flex;
            justify-content: space-between;
            padding-top: 12px;
            /* Add space between the buttons and the form elements above */
        }

        /* General button styles */
        .dropdown-btn {
            padding: 10px 20px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            font-weight: 600;
            margin: 4px;
            /* Add a small margin around buttons */
        }

        /* Specific styles for the cancel button */
        .cancel {
            background-color: #f7f7f7;
            /* Light gray background */
            color: #333;
            /* Dark text */
        }

        /* Specific styles for the apply button */
        .apply {
            background-color: #0074e4;
            /* Use the same blue as in the header */
            color: white;
            /* White text */
            border-color: #005cbf;
            /* Slightly darker border for some depth */
        }

        /* Hover styles for buttons */
        .dropdown-btn:hover {
            opacity: 0.8;
        }


        .nav-item {
            padding: 0.5em 1em;
            margin: 0 0.25em;
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .nav-item:not(.logo):hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .saved-searches a {
            margin-left: 20px;
            font-size: 0.9em;
        }

        .search-bar {
            width: 15%;
            /* Adjust the width of the search bar to 15% of its container */
            margin-right: 1em;
            /* Adjust if needed to create some space to the next element */
        }

        .search-box {
            width: 100%;
            /* This makes the input field take up the full width of its container, the .search-bar */
            padding: 0.5em;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 1em;
        }

        .search-options {
            display: flex;
            align-items: center;
        }

        .search-option,
        .search-button {
            padding: 0.5em 1em;
            margin-left: 0.5em;
            background-color: #f7f7f7;
            color: #333;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-option:hover,
        .search-button:hover {
            background-color: #e0e0e0;
        }

        .search-button {
            background-color: #0074e4;
            color: white;
        }

        .search-button:hover {
            background-color: #005cbf;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .listing-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .listing-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .listing-header p {
            font-size: 16px;
            color: #666;
            margin: 0;
        }

        .listing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .listing-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .listing-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
            cursor: pointer;
        }

        .listing-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .listing-details {
            padding: 10px;
        }

        .price-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .price-details h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            color: #006AFF;
        }

        .price-details p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .address {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .listing-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .listing-stats p {
            font-size: 14px;
            margin: 2px 0;
        }

        .custom-marker {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            color: #006AFF;
            width: 50px;
        }

        .custom-info-window {
            max-width: 200px;
            padding: 10px;
        }

        .custom-info-window img {
            width: 100%;
            height: auto;
            margin-bottom: 5px;
        }

        .custom-info-window h4 {
            margin: 0 0 5px;
        }

        .custom-info-window p {
            margin: 0;
        }

        .listing-section {
            margin-bottom: 20px;
        }

        .listing-section h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }
    </style>
    <script>
        $(document).ready(function () {
            // Toggle the dropdown on click
            $('.deals-dropdown .search-option').on('click', function (event) {
                $(this).next('.deals-dropdown-content').toggle();
                event.stopPropagation(); // Prevent event from bubbling up to the document
            });

            // Close the dropdown when clicking outside
            $(document).on('click', function () {
                $('.deals-dropdown-content').hide();
            });

            // Prevent the dropdown from closing when clicking inside it
            $('.deals-dropdown-content').on('click', function (event) {
                event.stopPropagation(); // Stop the click from propagating up to the document
            });

            // Hide dropdown when cancel is clicked
            $('#cancel-button').on('click', function () {
                $(this).closest('.deals-dropdown-content').hide();
            });

            // Logic for when apply is clicked
            $('#apply-button').on('click', function () {
                // You can call your function to apply filters here
                // For example:
                // applyFilters();

                $(this).closest('.deals-dropdown-content').hide();
            });
        });

    </script>
    <script type="text/javascript">
        var listingsData = JSON.parse("{{ data | tojson | safe }}");
    </script>


    <script>
        $(document).ready(function () {
            var dataTable = $('#house-listings').DataTable();

            // Sort event handler
            $('#sort-by').on('change', function () {
                var selectedOption = $(this).val();
                var columnIndex = getColumnIndex(selectedOption);
                dataTable.order([columnIndex, 'desc']).draw();
            });

            // Helper function to get the column index based on the selected option
            function getColumnIndex(option) {
                switch (option) {
                    case 'address':
                        return 0;
                    case 'cash_on_cash_return':
                        return 1;
                    case 'monthly_cash_flow':
                        return 2;
                    case 'cap_rate':
                        return 3;
                    case 'cash_to_close':
                        return 4;
                    default:
                        return 0;
                }
            }
        });
    </script>
    <script>
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: { lat: 42.686718, lng: -83.1338 } // Set this to a default location
            });

            var listings = JSON.parse('{{ data | tojson | safe }}');
            var infoWindow = new google.maps.InfoWindow();

            listings.forEach(function (listing) {
                var price = listing.price;
                var priceText = price >= 1000000 ? (price / 1000000).toFixed(1) + 'M' : (price / 1000).toFixed(0) + 'k';
                listing.priceText = priceText;
                listing.meetsCriteria = false; // Initialize meetsCriteria property

                var marker = new google.maps.Marker({
                    position: { lat: listing.latitude, lng: listing.longitude },
                    map: map,
                    title: listing.streetAddress,
                    icon: getMarkerIcon('#006AFF', priceText) // Initial blue icon
                });

                var infoWindowContent = `
            <div class="custom-info-window">
                <img src="${listing.imgSrc}" alt="House Image">
                <h4>${listing.streetAddress}</h4>
                <p>${listing.bedrooms} bds | ${listing.bathrooms} ba | ${listing.livingArea} sqft</p>
                <p>$${listing.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</p>
            </div>
        `;

                marker.addListener('click', function () {
                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(map, marker);
                });

                listing.marker = marker;
            });

            // Add this code block after the listings.forEach loop
            google.maps.event.addListener(map, 'zoom_changed', function () {
                listings.forEach(function (listing) {
                    listing.marker.setIcon(getMarkerIcon(listing.markerColor, listing.priceText));
                });
            });

            function isCloseToMetric(listingValue, inputValue, tolerancePercent) {
                var tolerance = inputValue * (tolerancePercent / 100);
                return listingValue >= (inputValue - tolerance) && listingValue <= (inputValue + tolerance);
            }

            let cocValue, cashToCloseValue, capRateLowValue, capRateHighValue;

            $('#apply-button').on('click', function () {
                updateMarkerColors();
                $(this).closest('.deals-dropdown-content').hide();
            });

            function updateMarkerColors() {
                cocValue = parseFloat(document.querySelector('input[name="coc"]').value);
                cashToCloseValue = parseFloat(document.querySelector('input[name="cash-to-close"]').value.replace(/,/g, ''));
                capRateLowValue = parseFloat(document.querySelector('input[name="cap-rate-low"]').value);
                capRateHighValue = parseFloat(document.querySelector('input[name="cap-rate-high"]').value);

                const dealsGrid = document.getElementById('deals-grid');
                const potentialDealsGrid = document.getElementById('potential-deals-grid');
                const otherListingsGrid = document.getElementById('other-listings-grid');

                dealsGrid.innerHTML = '';
                potentialDealsGrid.innerHTML = '';
                otherListingsGrid.innerHTML = '';

                listings.forEach(function (listing) {
                    const cashOnCashReturn = listing['Cash on Cash Return %'];
                    const cashToClose = listing['Cash To Close'];
                    const capRate = listing['Cap Rate'];

                    listing.meetsCriteria = (
                        cashOnCashReturn >= cocValue &&
                        cashToClose <= cashToCloseValue &&
                        capRate >= capRateLowValue &&
                        capRate <= capRateHighValue
                    );

                    const tolerancePercent = 5;
                    const cocLowerBound = cocValue - tolerancePercent;
                    const cocClose = cashOnCashReturn >= cocLowerBound && cashOnCashReturn < cocValue;

                    if (listing.meetsCriteria) {
                        listing.markerColor = '#4CAF50';
                        dealsGrid.innerHTML += createListingCard(listing);
                    } else if (cocClose && !listing.meetsCriteria) {
                        listing.markerColor = 'yellow';
                        potentialDealsGrid.innerHTML += createListingCard(listing);
                    } else {
                        listing.markerColor = '#006AFF';
                        otherListingsGrid.innerHTML += createListingCard(listing);
                    }

                    listing.marker.setIcon(getMarkerIcon(listing.markerColor, listing.priceText));
                });
                initListingHoverEvents();
            }


            function createListingCard(listing) {
                // Assuming listing.id is your unique identifier for each listing
                return `
        <div class="listing-card" data-listing-id="${listing.zpid}">
            <img src="${listing.imgSrc}" alt="House Image">
            <div class="listing-details">
                <div class="price-details">
                    <h3>$${listing.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</h3>
                    <p>${listing.bedrooms} bds | ${listing.bathrooms} ba | ${listing.livingArea} sqft</p>
                </div>
                <p class="address">${listing.streetAddress}</p>
                <p class="listing-info">${listing.homeType} | ${listing.city}, ${listing.state} ${listing.zipcode}</p>
                <div class="listing-stats">
                    <p>Cash on Cash Return: ${listing['Cash on Cash Return %']}%</p>
                    <p>Monthly Cash Flow: $${listing['Monthly Cash Flow'].toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</p>
                    <p>Cap Rate: ${listing['Cap Rate']}%</p>
                    <p>Cash to Close: $${listing['Cash To Close'].toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</p>
                </div>
            </div>
        </div>
    `;
            }

            function handleListingHover(event) {
                const listingId = event.currentTarget.getAttribute('data-listing-id');
                const listing = listings.find(function (listing) {
                    return listing.zpid == listingId;
                });

                if (listing) {
                    const size = event.type === 'mouseenter' ? 30 : 20;
                    listing.marker.setIcon(getMarkerIcon(listing.markerColor, listing.priceText, size));
                }
            }

            function initListingHoverEvents() {
                const listingCards = document.querySelectorAll('.listing-card');
                listingCards.forEach(function (card) {
                    card.addEventListener('mouseenter', handleListingHover);
                    card.addEventListener('mouseleave', handleListingHover);
                });
            }


            // Helper function to determine if a listing's value is 'close' to the user's input
            function isCloseToMetric(listingValue, inputValue, tolerancePercent) {
                var tolerance = inputValue * (tolerancePercent / 100);
                return listingValue >= (inputValue - tolerance) && listingValue <= (inputValue + tolerance);
            }

            var inputFields = document.querySelectorAll('.deals-dropdown-content input');
            inputFields.forEach(function (input) {
                input.addEventListener('change', updateMarkerColors);
            });

            updateMarkerColors(); // Initialize marker colors based on criteria


            function getMarkerIcon(color, priceText, size = 20) {
                const fontSize = size === 30 ? 14 : 10;
                const markerSVG = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size * 2} ${size}" width="${size * 2}" height="${size}">
            <rect x="0" y="0" width="${size * 2}" height="${size}" rx="${size / 2}" ry="${size / 2}" fill="${color}" />
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#FFFFFF" font-weight="bold" font-size="${fontSize}">${priceText}</text>
        </svg>
    `;
                return {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(markerSVG),
                    scaledSize: new google.maps.Size(size * 2, size),
                    anchor: new google.maps.Point(size, size / 2)
                };
            }
        }

    </script>
</head>

<body>

    <header>

        <div class="header-top">
            <a href="#" class="logo">Stefen</a>
            <div class="header-nav">
                <div class="nav-item">Buy</div>
                <div class="nav-item">Rent</div>
                <div class="nav-item">Sell</div>
                <div class="nav-item">Home Loans</div>
                <div class="nav-item">Agent Finder</div>
            </div>
            <div class="saved-searches">
                <a href="#" class="saved-links">Saved Homes</a>
                <a href="#" class="saved-links">Saved Searches</a>
            </div>
        </div>
        <div class="header-bottom">
            <div class="search-bar">
                <input type="text" class="search-box" placeholder="City, Neighborhood, ZIP, Address">
            </div>
            <div class="search-options">
                <button class="search-option">For Sale</button>
                <button class="search-option">Price</button>
                <button class="search-option">Beds &amp; Baths</button>
                <button class="search-option">Home Type</button>
                <div class="deals-dropdown">
                    <button class="search-option">Deals</button>
                    <div class="deals-dropdown-content">
                        <label>CoC: <input type="text" name="coc" value="5%" /></label>
                        <label>Cash to Close: <input type="text" name="cash-to-close" value="100,000" /></label>
                        <label>Cap Rate (Low): <input type="text" name="cap-rate-low" value="5%" /></label>
                        <label>Cap Rate (High): <input type="text" name="cap-rate-high" value="10%" /></label>
                        <!-- Add more fields as needed -->
                        <div class="dropdown-buttons">
                            <button id="cancel-button" class="dropdown-btn cancel">Cancel</button>
                            <button id="apply-button" class="dropdown-btn apply">Apply</button>
                        </div>
                    </div>
                </div>
                <button class="search-option">More</button>
                <button class="search-button">Save Search</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="map"></div>
        <div class="listing-container">
            <div class="listing-header">
                <h2>Real Estate & Homes For Sale</h2>
                <p>{{ data|length }} results</p>
            </div>
            <div class="sort-dropdown">
                <label for="sort-by">Sort by:</label>
                <select id="sort-by">
                    <option value="price">Price</option>
                    <option value="bedrooms">Bedrooms</option>
                    <option value="bathrooms">Bathrooms</option>
                    <!-- Add more sorting options as needed -->
                </select>
            </div>
            <div class="listing-section">
                <h3>Deals</h3>
                <div id="deals-grid" class="listing-grid"></div>
            </div>
            <div class="listing-section">
                <h3>Potential Deals</h3>
                <div id="potential-deals-grid" class="listing-grid"></div>
            </div>
            <div class="listing-section">
                <h3>Other</h3>
                <div id="other-listings-grid" class="listing-grid"></div>
            </div>
        </div>
    </div>
    <script>
        // Ensure this script block is after the script block where listingsData is defined
        $(document).ready(function () {
            listingsData.forEach(function (listing) {
                var listingCardHTML = `
                    <div class="listing-card" data-listing-id="${listing.zpid}">
                        <img src="${listing.imgSrc}" alt="House Image">
                        <div class="listing-details">
                            <!-- Add more details here -->
                            <h5>${listing.streetAddress}, ${listing.city}</h5>
                            <p>${listing.price}</p>
                        </div>
                    </div>
                `;
                // Append this card to your listings container
                $('.listing-container').append(listingCardHTML);
            });
        });
    </script>

</body>

</html>